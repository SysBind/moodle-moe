YUI.add("moodle-editor_atto-editor",function(e,t){function i(){var e=this.getHTML(),t=[{regex:/<!--[\s\S]*?-->/gi,replace:""},{regex:/<\\?\?xml[^>]*>/gi,replace:""},{regex:/<\/?\w+:[^>]*>/gi,replace:""},{regex:/\s*MSO[-:][^;"']*;?/gi,replace:""},{regex:/<span[^>]*>(&nbsp;|\s)*<\/span>/gi,replace:""},{regex:/class="Mso[^"]*"/gi,replace:""},{regex:/<(\/?title|\/?meta|\/?style|\/?st\d|\/?head|\/?font|\/?html|\/?body|!\[)[^>]*?>/gi,replace:""},{regex:new RegExp(String.fromCharCode(8220),"gi"),replace:'"'},{regex:new RegExp(String.fromCharCode(8216),"gi"),replace:"'"},{regex:new RegExp(String.fromCharCode(8217),"gi"),replace:"'"},{regex:new RegExp(String.fromCharCode(8211),"gi"),replace:"-"},{regex:new RegExp(String.fromCharCode(8212),"gi"),replace:"--"},{regex:new RegExp(String.fromCharCode(189),"gi"),replace:"1/2"},{regex:new RegExp(String.fromCharCode(188),"gi"),replace:"1/4"},{regex:new RegExp(String.fromCharCode(190),"gi"),replace:"3/4"},{regex:new RegExp(String.fromCharCode(169),"gi"),replace:"(c)"},{regex:new RegExp(String.fromCharCode(174),"gi"),replace:"(r)"},{regex:new RegExp(String.fromCharCode(8230),"gi"),replace:"..."}],n=0,r;for(n=0;n<t.length;n++)r=t[n],e=e.replace(r.regex,r.replace);return this.setHTML(e),this}CSS={CONTENT:"editor_atto_content",CONTENTWRAPPER:"editor_atto_content_wrap",TOOLBAR:"editor_atto_toolbar",WRAPPER:"editor_atto",HIGHLIGHT:"highlight"},M.editor_atto=M.editor_atto||{BLOCK_TAGS:["address","article","aside","audio","blockquote","canvas","dd","div","dl","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","noscript","ol","output","p","pre","section","table","tfoot","ul","video"],PLACEHOLDER_FONTNAME:"yui-tmp",ALL_NODES_SELECTOR:"[style],font[face]",FONT_FAMILY:"fontFamily",buttonhandlers:{},textupdatedhandlers:{},menus:{},menuhandlers:{},filepickeroptions:{},widgets:{},selections:{},focusfromclick:!1,eventspublished:!1,lastselection:null,firstinit:!0,showhide_menu_handler:function(t){t.preventDefault();var n=this.getAttribute("disabled"),r=this.getAttribute("data-menu"),i=M.editor_atto.menus[r],s=i.get("bodyContent");if(i.get("visible")||n)i.hide(),s.detach("clickoutside");else{s.on("clickoutside",function(e){e.target.ancestor()!==this&&e.target!==this&&i.get("visible")&&(s.detach("clickoutside"),i.hide())},this),i.align(e.one(e.config.doc.body),[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),i.show();var o=t.target.ancestor("button",!0).one("img");i.align(o,[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),i.get("boundingBox").one("a").focus()}},buttonclicked_handler:function(t){var n=this.getAttribute("data-editor"),r=this.getAttribute("data-plugin"),i=this.getAttribute("data-button"),s=this.getAttribute("data-handler"),o=M.editor_atto.menus[r+"_"+n],u=M.editor_atto.get_toolbar_node(n),a=u.getAttribute("aria-activedescendant");a&&(current=e.one("#"+a),current.setAttribute("tabindex","-1")),this.setAttribute("tabindex",0),u.setAttribute("aria-activedescendant",this.generateID()),o&&o.hide();if(M.editor_atto.is_enabled(n,r,i))return s=M.editor_atto.buttonhandlers[s],s(t,n)},disable_all_widgets:function(e){var t,n,r=M.editor_atto.get_toolbar_node(e);for(t in M.editor_atto.widgets)n=r.one(".atto_"+t+"_button"),n&&n.setAttribute("disabled","true")},get_textarea_node:function(t){return e.one(document.getElementById(t))},get_toolbar_node:function(t){return e.one(document.getElementById(t+"_toolbar"))},get_editable_node:function(t){return e.one(document.getElementById(t+"editable"))},is_enabled:function(e,t,n){var r=t;n&&(r+="_"+n);var i=M.editor_atto.get_toolbar_node(e).one(".atto_"+r+"_button");return!i.hasAttribute("disabled")},is_highlighted:function(e,t,n){var r=t;n&&(r+="_"+n);var i=M.editor_atto.get_toolbar_node(e).one(".atto_"+r+"_button");return!i.hasClass(CSS.HIGHLIGHT)},enable_widget:function(e,t,n){var r=t;n&&(r+="_"+n);var i=M.editor_atto.get_toolbar_node(e).one(".atto_"+r+"_button");i&&i.removeAttribute("disabled")},add_widget_highlight:function(e,t,n){var r=t;n&&(r+="_"+n);var i=M.editor_atto.get_toolbar_node(e).one(".atto_"+r+"_button");i&&i.addClass(CSS.HIGHLIGHT)},remove_widget_highlight:function(e,t,n){var r=t;n&&(r+="_"+n);var i=M.editor_atto.get_toolbar_node(e).one(".atto_"+r+"_button");i&&i.removeClass(CSS.HIGHLIGHT)},enable_all_widgets:function(e){var t,n;for(t in M.editor_atto.widgets)n=M.editor_atto.get_toolbar_node(e).one(".atto_"+t+"_button"),n&&n.removeAttribute("disabled")},add_text_updated_handler:function(e,t){e in M.editor_atto.textupdatedhandlers||(M.editor_atto.textupdatedhandlers[e]=[]),M.editor_atto.textupdatedhandlers[e].push(t)},add_toolbar_menu:function(t,n,r,i,s,o,u,a,f){var l=M.editor_atto.get_toolbar_node(t),c=l.one(".atto_group."+i+"_group"),h,p,d,v;o?d=n+"_"+o:(o="",d=n),u||(u=M.util.get_string("pluginname","atto_"+n)),typeof a=="undefined"&&(a="14"),typeof f=="undefined"&&(f="transparent"),c||(c=e.Node.create('<div class="atto_group '+i+'_group"></div>'),l.append(c)),v=M.util.image_url("t/expanded","moodle"),p=e.Node.create('<button class="atto_'+d+'_button atto_hasmenu" '+'data-editor="'+e.Escape.html(t)+'" '+'tabindex="-1" '+'type="button" '+'data-menu="'+d+"_"+t+'" '+'title="'+e.Escape.html(u)+'">'+'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" '+'style="background-color:'+f+';" src="'+r+'"/>'+'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" src="'+v+'"/>'+"</button>"),c.append(p),h=l.getAttribute("aria-activedescendant"),h||(p.setAttribute("tabindex","0"),l.setAttribute("aria-activedescendant",p.generateID())),M.editor_atto.widgets[d]=d;var m=e.Node.create('<div class="atto_'+d+"_menu"+' atto_menu" data-editor="'+e.Escape.html(t)+'"'+' style="min-width:'+(a-2)+'em"'+'"></div>'),g=0,y={};for(g=0;g<s.length;g++){y=s[g];var b=e.Node.create('<div tabindex="-1" class="atto_menuentry"><a href="#" class="atto_'+d+"_action_"+g+'" '+'data-editor="'+e.Escape.html(t)+'" '+'data-plugin="'+e.Escape.html(n)+'" '+'data-button="'+
e.Escape.html(o)+'" '+'data-handler="'+e.Escape.html(d+"_action_"+g)+'">'+y.text+"</a>"+"</div>");b.on("keydown",M.editor_atto.menu_item_arrow_key_handler,null,p),m.append(b),M.editor_atto.buttonhandlers[n+"_action_"+g]||(e.one("body").delegate("click",M.editor_atto.buttonclicked_handler,".atto_"+d+"_action_"+g),e.one("body").delegate("key",M.editor_atto.buttonclicked_handler,"32,enter",".atto_"+d+"_action_"+g),M.editor_atto.buttonhandlers[d+"_action_"+g]=y.handler)}M.editor_atto.buttonhandlers[d]||(e.one("body").delegate("click",M.editor_atto.showhide_menu_handler,".atto_"+d+"_button"),M.editor_atto.buttonhandlers[d]=!0);var w=new M.core.dialogue({bodyContent:m,visible:!1,width:a+"em",closeButton:!1,center:!1,render:!0});M.editor_atto.menus[d+"_"+t]=w,w.align(p,[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),w.headerNode.hide()},menu_item_arrow_key_handler:function(e,t){var n;if(e.keyCode===40||e.keyCode===37){e.preventDefault();var r=e.currentTarget.get("nextSibling");r===null&&(n=e.currentTarget.siblings(),r=n.item(0)),r.get("firstChild").focus()}else if(e.keyCode===38||e.keyCode===39){e.preventDefault();var i=e.currentTarget.get("previousSibling");i===null&&(n=e.currentTarget.siblings(),i=n.item(n.size()-1)),i.get("firstChild").focus()}else if(e.keyCode===9||e.keyCode===27){e.preventDefault();var s=M.editor_atto.menus[t.getAttribute("data-menu")],o=s.get("bodyContent");s.hide(),o.detach("clickoutside"),t.focus()}},add_toolbar_button:function(t,n,r,i,s,o,u){var a=M.editor_atto.get_toolbar_node(t),f=a.one(".atto_group."+i+"_group"),l,c,h;o?c=n+"_"+o:(o="",c=n),u||(u=M.util.get_string("pluginname","atto_"+n)),f||(f=e.Node.create('<div class="atto_group '+i+'_group"></div>'),a.append(f)),l=e.Node.create('<button class="atto_'+c+'_button" '+'data-editor="'+e.Escape.html(t)+'" '+'data-plugin="'+e.Escape.html(n)+'" '+'data-button="'+e.Escape.html(o)+'" '+'tabindex="-1" '+'data-handler="'+e.Escape.html(c)+'" '+'title="'+e.Escape.html(u)+'">'+'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" src="'+r+'"/>'+"</button>"),f.append(l),h=a.getAttribute("aria-activedescendant"),h||(l.setAttribute("tabindex","0"),a.setAttribute("aria-activedescendant",l.generateID())),M.editor_atto.buttonhandlers[c]||(e.one("body").delegate("click",M.editor_atto.buttonclicked_handler,".atto_"+c+"_button"),M.editor_atto.buttonhandlers[c]=s),M.editor_atto.widgets[c]=c},is_active:function(e){var t=rangy.createRange(),n=M.editor_atto.get_editable_node(e),r=rangy.getSelection();return r.rangeCount?(t.selectNode(n.getDOMNode()),t.intersectsRange(r.getRangeAt(0))):!1},focus:function(e){M.editor_atto.get_editable_node(e).focus()},update_from_textarea:function(t){var n=M.editor_atto.get_editable_node(t),r=M.editor_atto.get_textarea_node(t);n.setHTML(""),n.append(r.get("value")),n.cleanHTML(),n.getHTML()===""&&(e.UA.ie&&e.UA.ie<10?n.setHTML("<p></p>"):n.setHTML("<p><br></p>"))},init:function(t){var n=this.firstinit;this.firstinit=!1;var r=e.Node.create('<div class="'+CSS.WRAPPER+'" />'),i=e.Node.create('<div id="'+t.elementid+'editable" '+'contenteditable="true" '+'role="textbox" '+'spellcheck="true" '+'aria-live="off" '+'class="'+CSS.CONTENT+'" '+'data-editor="'+t.elementid+'" />'),s=e.Node.create('<div class="'+CSS.TOOLBAR+'" id="'+t.elementid+'_toolbar" role="toolbar" aria-live="off"/>'),o=e.Node.create('<div class="'+CSS.CONTENTWRAPPER+'" />'),u=M.editor_atto.get_textarea_node(t.elementid),a=e.one('[for="'+t.elementid+'"]');a&&(a.generateID(),i.setAttribute("aria-labelledby",a.get("id")),s.setAttribute("aria-labelledby",a.get("id"))),o.appendChild(i),r.appendChild(s),r.appendChild(o),i.setStyle("minHeight",1.2*u.getAttribute("rows")+"em"),u.get("parentNode").insert(r,u),M.editor_atto.disable_css_styling(),u.hide(),this.update_from_textarea(t.elementid),this.publish_events(),i.on("atto:selectionchanged",this.save_selection,this,t.elementid),n&&(this.publish_events(),this.on("atto:selectionchanged",this.save_selection,this)),i.on("focus",this.restore_selection,this,t.elementid),i.on("mousedown",function(){this.focusfromclick=!0},this),i.on("blur",function(){this.focusfromclick=!1,this.text_updated(t.elementid)},this),document.queryCommandSupported("DefaultParagraphSeparator")&&document.execCommand("DefaultParagraphSeparator",!1,"p"),e.one(e.config.doc.body).delegate("key",this.keyboard_navigation,"down:37,39","#"+t.elementid+"_toolbar",this,t.elementid),M.editor_atto.filepickeroptions[t.elementid]=t.filepickeroptions;var f,l,c,h;for(f=0;f<t.plugins.length;f++){c=t.plugins[f].group;for(l=0;l<t.plugins[f].plugins.length;l++)h=t.plugins[f].plugins[l],h.params.elementid=t.elementid,h.params.group=c,M["atto_"+h.name].init(h.params)}for(f=0;f<t.plugins.length;f++){c=t.plugins[f].group;for(l=0;l<t.plugins[f].plugins.length;l++)h=t.plugins[f].plugins[l],h.params.elementid=t.elementid,h.params.group=c,typeof M["atto_"+h.name].after_init!="undefined"&&M["atto_"+h.name].after_init(h.params)}},publish_events:function(){this.eventspublished||(e.publish("atto:selectionchanged",{prefix:"atto"}),e.delegate(["mouseup","keyup","focus"],this._has_selection_changed,document.body,"."+CSS.CONTENT,this),this.eventspublished=!0)},text_updated:function(e){var t=M.editor_atto.get_textarea_node(e),n=this.get_clean_html(e);t.set("value",n),t.simulate("change");var r=0;if(e in M.editor_atto.textupdatedhandlers)for(r=0;r<M.editor_atto.textupdatedhandlers[e].length;r++){var i=M.editor_atto.textupdatedhandlers[e][r];i(e)}},get_clean_html:function(t){var n=M.editor_atto.get_editable_node(t).cloneNode(!0);return e.each(n.all("[id]"),function(e){var t=e.get("id");t.indexOf("yui")===0&&e.removeAttribute("id")}),n.cleanHTML(),(n.getHTML()==="<p></p>"||n.getHTML()==="<p><br></p>")&&n.setHTML(""),n.getHTML()},keyboard_navigation:function(t,n){var r,i,s,o,u=M.editor_atto.get_toolbar_node(n);t.preventDefault(),r=u.all("empty"),u.all(".atto_group").each(function(e){e.hasAttribute("hidden")||(r=r.concat(e.all("button")))}),s=u.getAttribute
("aria-activedescendant");if(!s)return;i=e.one("#"+s),i.setAttribute("tabindex","-1"),o=r.indexOf(i),t.keyCode===37?(o--,o<0&&(o=r.size()-1)):(o++,o>=r.size()&&(o=0)),i=r.item(o),i.setAttribute("tabindex","0"),i.focus(),u.setAttribute("aria-activedescendant",i.generateID())},can_show_filepicker:function(e,t){var n=M.editor_atto.filepickeroptions[e];return typeof n[t]!="undefined"},show_filepicker:function(t,n,r){e.use("core_filepicker",function(e){var i=M.editor_atto.filepickeroptions[t][n];i.formcallback=r,M.core_filepicker.show(e,i)})},get_selection_from_node:function(e){var t=rangy.createRange();return t.selectNode(e.getDOMNode()),[t]},save_selection:function(e){var t=e.elementid;t&&this.is_active(t)&&(this.selections[t]=this.get_selection())},restore_selection:function(e,t){this.focusfromclick||typeof this.selections[t]!="undefined"&&this.set_selection(this.selections[t]),this.focusfromclick=!1},get_selection:function(){return rangy.getSelection().getAllRanges()},selection_contains_node:function(e){return rangy.getSelection().containsNode(e.getDOMNode(),!0)},selection_filter_matches:function(e,t,n,r){typeof r=="undefined"&&(r=!0),n||(n=M.editor_atto.get_selected_nodes(e));var i=n.size()>0,s=!1;return n.each(function(n){if(r){if(!i||!n.ancestor(t,!0,"#"+e+"editable"))i=!1}else!s&&n.ancestor(t,!0,"#"+e+"editable")&&(s=!0)},this),r?i:s},get_selected_nodes:function(t){var n=new e.NodeList,r,i,s,o,u;i=rangy.getSelection(),i.rangeCount?s=i.getRangeAt(0):s=rangy.createRange(),s.collapsed&&s.selectNode(s.commonAncestorContainer),r=s.getNodes();for(u=0;u<r.length;u++)o=e.one(r[u]),o.ancestor("#"+t+"editable")&&n.push(o);return n},_has_selection_changed:function(e){var t=rangy.getSelection(),n,r=!1;return t.rangeCount?n=t.getRangeAt(0):n=rangy.createRange(),this.lastselection&&!this.lastselection.equals(n)?(r=!0,this._fire_selectionchanged(e)):(this.lastselection=n,r)},_fire_selectionchanged:function(e){var t=e.currentTarget.get("id"),n=t.substring(0,t.length-8),r=this.get_selected_nodes(n);this.fire("atto:selectionchanged",{event:e,elementid:n,selectedNodes:r})},get_selection_parent_node:function(){var e=rangy.getSelection();return e.rangeCount?e.getRangeAt(0).commonAncestorContainer:!1},set_selection:function(e){var t=rangy.getSelection();t.setRanges(e)},format_selection_block:function(t,n,r){var i=M.editor_atto.get_selection_parent_node(),s,o,u,a,f,l;if(!i)return;s=M.editor_atto.get_editable_node(t),i=e.one(i),o=i.ancestor(function(e){var t=e.get("tagName");return t&&(t=t.toLowerCase()),e===s||t==="td"||t==="th"},!0),o&&(s=o),u=i.ancestor(M.editor_atto.BLOCK_TAGS.join(", "),!0),u&&(f=u.ancestor(function(e){return e===s},!1),f||(u=!1)),u||(a=e.Node.create("<p></p>"),s.get("childNodes").each(function(e){a.append(e.remove())}),s.append(a),u=a),n&&n!==""&&(l=e.Node.create("<"+n+"></"+n+">"),l.setAttrs(u.getAttrs()),u.get("childNodes").each(function(e){e.remove(),l.append(e)}),u.replace(l),u=l),r&&u.setAttrs(r);var c=M.editor_atto.get_selection_from_node(u);return M.editor_atto.set_selection(c),u},disable_css_styling:function(){try{document.execCommand("styleWithCSS",0,!1)}catch(e){try{document.execCommand("useCSS",0,!0)}catch(t){try{document.execCommand("styleWithCSS",!1,!1)}catch(n){}}}},enable_css_styling:function(){try{document.execCommand("styleWithCSS",0,!0)}catch(e){try{document.execCommand("useCSS",0,!1)}catch(t){try{document.execCommand("styleWithCSS",!1,!0)}catch(n){}}}},insert_html_at_focus_point:function(t){var n=rangy.getSelection(),r,i=e.Node.create(t);n.rangeCount&&(r=n.getRangeAt(0)),r&&(r.deleteContents(),r.insertNode(i.getDOMNode()))},toggle_inline_selection_class:function(t,n){var r=M.editor_atto.get_selection_parent_node(),i=e.one("body"),s,o=[],u,a,f,l=0;if(!r)return;document.execCommand("fontname",!1,M.editor_atto.PLACEHOLDER_FONTNAME),s=i.all(M.editor_atto.ALL_NODES_SELECTOR),s.each(function(t,n){t.getStyle(M.editor_atto.FONT_FAMILY)===M.editor_atto.PLACEHOLDER_FONTNAME&&(t.setStyle(M.editor_atto.FONT_FAMILY,""),t.compareTo(i)||o.push(e.Node.getDOMNode(s.item(n))))});for(l=0;l<o.length;l++){a=e.one(o[l]),u=a.ancestor(".editor_atto_content span"),u?a=u:(f=e.Node.create("<span></span>"),f.append(o[l].innerHTML),a.replace(f),a=f);for(var c=0;c<n.length;c++)a.toggleClass(n[c])}}},e.augment(M.editor_atto,e.EventTarget);var n="Controlmenu",r;r=function(e){e.draggable=!1,e.center=!1,e.width="auto",e.lightbox=!1,e.footerContent="",e.hideOn=[{eventName:"clickoutside"}],r.superclass.constructor.apply(this,[e])},e.extend(r,M.core.dialogue,{initializer:function(t){var n,i,s;r.superclass.initializer.call(this,t),s=this.get("boundingBox"),s.addClass("editor_atto_controlmenu"),n=this.bodyNode,i=e.Node.create("<h3/>"),i.addClass("accesshide"),i.setHTML(this.get("headerText")),n.prepend(i)}},{NAME:n,ATTRS:{headerText:{value:""}}}),M.editor_atto=M.editor_atto||{},M.editor_atto.controlmenu=r,e.Node.addMethod("cleanHTML",i),e.NodeList.importMethod(e.Node.prototype,"cleanHTML")},"@VERSION@",{requires:["node","io","overlay","escape","event","event-simulate","event-custom","yui-throttle","moodle-core-notification-dialogue","moodle-editor_atto-rangy"]});
