YUI.add("moodle-atto_equation-button",function(e,t){var n="atto_equation",r={EQUATION_TEXT:"atto_equation_equation",EQUATION_PREVIEW:"atto_equation_preview",SUBMIT:"atto_equation_submit",LIBRARY:"atto_equation_library",LIBRARY_GROUP_PREFIX:"atto_equation_library"},i={LIBRARY_GROUP_PREFIX:"."+r.LIBRARY_GROUP_PREFIX,EQUATION_TEXT:"."+r.EQUATION_TEXT,EQUATION_PREVIEW:"."+r.EQUATION_PREVIEW,SUBMIT:"."+r.SUBMIT,LIBRARY_BUTTON:"."+r.LIBRARY+" button"},s={START:"\\(",END:"\\)"},o={FORM:'<form class="atto_form">{{{library}}}<label for="{{elementid}}_{{CSS.EQUATION_TEXT}}">{{{get_string "editequation" component texdocsurl}}}</label><textarea class="fullwidth {{CSS.EQUATION_TEXT}}" id="{{elementid}}_{{CSS.EQUATION_TEXT}}" rows="8"></textarea><br/><label for="{{elementid}}_{{CSS.EQUATION_PREVIEW}}">{{get_string "preview" component}}</label><div class="fullwidth {{CSS.EQUATION_PREVIEW}}" id="{{elementid}}_{{CSS.EQUATION_PREVIEW}}"></div><div class="mdl-align"><br/><button class="{{CSS.SUBMIT}}">{{get_string "saveequation" component}}</button></div></form>',LIBRARY:'<div class="{{CSS.LIBRARY}}"><ul>{{#each library}}<li><a href="#{{elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}{{@key}}">{{get_string groupname ../component}}</a></li>{{/each}}</ul><div>{{#each library}}<div id="{{elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}{{@key}}">{{#split "\n" elements}}<button data-tex="{{this}}" title="{{this}}">{{../../DELIMITERS.START}}{{this}}{{../../DELIMITERS.END}}</button>{{/split}}</div>{{/each}}</div></div>'};e.namespace("M.atto_equation").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_lastCursorPos:0,_content:null,_sourceEquation:"",initializer:function(){this.get("texfilteractive")&&(this.addButton({icon:"e/math",callback:this._displayDialogue}),this.get("host").on("atto:selectionchanged",function(){this._resolveEquation()?this.highlightButtons():this.unHighlightButtons()},this),this.editor.all("tex").each(function(t){var n=e.Node.create("<span>"+s.START+" "+t.get("text")+" "+s.END+"</span>");t.replace(n)}))},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;var t=this.getDialogue({headerContent:M.util.get_string("pluginname",n),focusAfterHide:!0,width:600}),r=this._getDialogueContent();t.set("bodyContent",r);var s=r.one(i.LIBRARY_GROUP_PREFIX),o=new e.TabView({srcNode:s});o.render(),t.show(),e.fire(M.core.event.FILTER_CONTENT_UPDATED,{nodes:new e.NodeList(t.get("boundingBox"))});var u=this._resolveEquation();u&&r.one(i.EQUATION_TEXT).set("text",u),this._updatePreview(!1)},_resolveEquation:function(){var t=this.get("host").getSelectionParentNode(),n,r,i=[],s;if(!t)return!1;n=e.one(t).get("text"),i.push(/\$\$([\S\s]*)\$\$/),i.push(/\\\(([\S\s]*)\\\)/),i.push(/\\\[([\S\s]*)\\\]/),i.push(/\[tex\]([\S\s]*)\[\/tex\]/);for(s=0;s<i.length;s++){pattern=i[s],r=pattern.exec(n);if(r&&r.length)return this.sourceEquation=r=r[1],r}return this.sourceEquation="",!1},_setEquation:function(t){var n,r,i,o,u;u=this.get("host"),t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),n=t.currentTarget.ancestor(".atto_form").one("textarea"),o=n.get("value"),o!==""&&(u.setSelection(this._currentSelection),this.sourceEquation.length?(r=e.one(u.getSelectionParentNode()),i=r.get("text"),i=i.replace(this.sourceEquation,o),r.set("text",i)):(o=s.START+" "+o+" "+s.END,u.insertContentAtFocusPoint(o)),this.markUpdated())},_throttle:function(e,t){var n=null;return function(){var r=this,i=arguments;clearTimeout(n),n=setTimeout(function(){e.apply(r,i)},t)}},_updatePreview:function(t){var n=this._content.one(i.EQUATION_TEXT),r=n.get("value"),o,u,a=n.get("selectionStart"),f="",l="\\square ",c,h;t&&t.preventDefault(),a||(a=0);while(r.charAt(a)==="\\"&&a>0)a-=1;c=/[a-zA-Z\{\}]/;while(c.test(r.charAt(a))&&a<r.length)a+=1;this._lastCursorPos=a,r=f+r.substring(0,a)+l+r.substring(a);var p=this._content.one(i.EQUATION_PREVIEW);r=s.START+" "+r+" "+s.END,o=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",h={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:r},u=e.io(o,{sync:!0,data:h}),u.status===200&&(p.setHTML(u.responseText),e.fire(M.core.event.FILTER_CONTENT_UPDATED,{nodes:new e.NodeList(p)}))},_getDialogueContent:function(){var t=this._getLibraryContent(),s=e.Handlebars.compile(o.FORM);return this._content=e.Node.create(s({elementid:this.get("host").get("elementid"),component:n,library:t,texdocsurl:this.get("texdocsurl"),CSS:r})),this._content.one(i.SUBMIT).on("click",this._setEquation,this),this._content.one(i.EQUATION_TEXT).on("valuechange",this._throttle(this._updatePreview,500),this),this._content.one(i.EQUATION_TEXT).on("mouseup",this._throttle(this._updatePreview,500),this),this._content.one(i.EQUATION_TEXT).on("keyup",this._throttle(this._updatePreview,500),this),this._content.delegate("click",this._selectLibraryItem,i.LIBRARY_BUTTON,this),this._content},_selectLibraryItem:function(e){var t=e.currentTarget.getAttribute("data-tex");e.preventDefault(),input=e.currentTarget.ancestor(".atto_form").one("textarea"),value=input.get("value"),value=value.substring(0,this._lastCursorPos)+t+value.substring(this._lastCursorPos,value.length),input.set("value",value),input.focus();var n=this._lastCursorPos+t.length,r=input.getDOMNode();if(typeof r.selectionStart=="number")r.selectionStart=r.selectionEnd=n;else if(typeof r.createTextRange!="undefined"){var i=r.createTextRange();i.moveToPoint(n),i.select()}this._updatePreview(!1)},_getLibraryContent:function(){var t=e.Handlebars.compile(o.LIBRARY),i=this.get("library"),u="";e.Handlebars.registerHelper("split",function(e,t,n){var r,i,s;if(typeof e=="undefined"||typeof t=="undefined")return"";s="",r=t.trim().split(e);while(r.length>0)i=r.shift().trim(),s+=n.fn(i);return s}),u=t({elementid:this.get("host").get("elementid"),component:n,library:i,CSS:r,DELIMITERS:s});var a=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",f={sesskey:M.cfg.sesskey,contextid
:this.get("contextid"),action:"filtertext",text:u};return preview=e.io(a,{sync:!0,data:f,method:"POST"}),preview.status===200&&(u=preview.responseText),u}},{ATTRS:{texfilteractive:{value:!1},contextid:{value:null},library:{value:{}},texdocsurl:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","moodle-core-event","io","event-valuechange","tabview"]});
