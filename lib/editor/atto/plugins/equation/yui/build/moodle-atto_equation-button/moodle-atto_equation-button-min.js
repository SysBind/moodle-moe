YUI.add("moodle-atto_equation-button",function(e,t){M.atto_equation=M.atto_equation||{dialogue:null,selection:null,contextids:{},library:{},lastcursor:0,display_chooser:function(t,n){t.preventDefault(),M.editor_atto.is_active(n)||M.editor_atto.focus(n),M.atto_equation.selection=M.editor_atto.get_selection();if(M.atto_equation.selection!==!1&&!M.atto_equation.selection.collapsed){var r;M.atto_equation.dialogue?r=M.atto_equation.dialogue:r=new M.core.dialogue({visible:!1,modal:!0,close:!0,draggable:!0,width:"800px"}),r.render(),r.set("bodyContent",M.atto_equation.get_form_content(n)),r.set("headerContent",M.util.get_string("pluginname","atto_equation"));var i=new e.TabView({srcNode:"#atto_equation_library"});i.render(),r.show();var s=M.atto_equation.resolve_equation();s&&e.one("#atto_equation_equation").set("text",s),M.atto_equation.update_preview(!1,n),M.atto_equation.dialogue=r}},init:function(e){var t=M.util.image_url("e/math","core");if(e.texfilteractive){this.contextids[e.elementid]=e.contextid,this.library=e.library,M.editor_atto.add_toolbar_button(e.elementid,"equation",t,e.group,this.display_chooser);var n=M.editor_atto.get_editable_node(e.elementid);n.on("atto:selectionchanged",function(e){M.atto_equation.resolve_equation()!==!1?M.editor_atto.add_widget_highlight(e.elementid,"equation"):M.editor_atto.remove_widget_highlight(e.elementid,"equation")})}},resolve_equation:function(){var t=M.editor_atto.get_selection_parent_node(),n,r;return t?(n=e.one(t).get("text"),pattern=/\$\$[\S\s]*\$\$/,r=pattern.exec(n),r&&r.length?(r=r.pop(),r=r.substring(2,r.length-2),r):!1):!1},set_equation:function(t,n){var r,i,s,o,u,a;t.preventDefault(),M.atto_equation.dialogue.hide(),M.editor_atto.set_selection(M.atto_equation.selection),r=t.currentTarget.ancestor(".atto_form").one("textarea"),a=r.get("value"),a!==""&&(a="$$ "+a.trim()+" $$",i=e.one(M.editor_atto.get_selection_parent_node()),s=i.get("text"),o=/\$\$[\S\s]*\$\$/,u=o.exec(s),u&&u.length?(u=u.pop(),s=s.replace(u,"$$"+a+"$$"),i.set("text",s)):M.editor_atto.insert_html_at_focus_point(a),M.editor_atto.text_updated(n))},update_preview:function(t,n){var r=e.one("#atto_equation_equation"),i=r.get("value"),s,o,u="",a="\\square ",f=r.get("selectionStart");f||(f=0);while(i.charAt(f)==="\\"&&f>0)f-=1;var l=/[\w\{\}]/;while(l.test(i.charAt(f))&&f<i.length)f+=1;this.lastcursorpos=f,i=u+i.substring(0,f)+a+i.substring(f),t&&t.preventDefault(),s=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",params={sesskey:M.cfg.sesskey,contextid:this.contextids[n],action:"filtertext",text:"$$ "+i+" $$"},o=e.io(s,{sync:!0,data:params}),o.status===200&&e.one("#atto_equation_preview").setHTML(o.responseText)},get_form_content:function(t){var n=e.Node.create('<form class="atto_form">'+this.get_library_html(t)+'<label for="atto_equation_equation">'+M.util.get_string("editequation","atto_equation")+"</label>"+'<textarea class="fullwidth" id="atto_equation_equation" rows="8"></textarea><br/>'+"<p>"+M.util.get_string("editequation_desc","atto_equation")+"</p>"+'<label for="atto_equation_preview">'+M.util.get_string("preview","atto_equation")+"</label>"+'<div class="fullwidth" id="atto_equation_preview"></div>'+'<div class="mdl-align">'+"<br/>"+'<button id="atto_equation_submit">'+M.util.get_string("saveequation","atto_equation")+"</button>"+"</div>"+"</form>");return n.one("#atto_equation_submit").on("click",M.atto_equation.set_equation,this,t),n.one("#atto_equation_equation").on("valuechange",M.atto_equation.update_preview,this,t),n.one("#atto_equation_equation").on("keyup",M.atto_equation.update_preview,this,t),n.one("#atto_equation_equation").on("mouseup",M.atto_equation.update_preview,this,t),n.delegate("click",M.atto_equation.select_library_item,"#atto_equation_library button",this,t),n},select_library_item:function(e,t){var n=e.currentTarget.getAttribute("data-tex");e.preventDefault(),input=e.currentTarget.ancestor(".atto_form").one("textarea"),value=input.get("value"),value=value.substring(0,this.lastcursorpos)+n+value.substring(this.lastcursorpos,value.length),input.set("value",value),M.atto_equation.update_preview(!1,t),input.focus()},get_library_html:function(t){var n='<div id="atto_equation_library">',r=0,i=1;n+="<ul>";for(i=1;i<5;i++)n+='<li><a href="#atto_equation_library'+i+'">'+M.util.get_string("librarygroup"+i,"atto_equation")+"</a></li>";n+="</ul>",n+="<div>";for(i=1;i<5;i++){n+='<div id="atto_equation_library'+i+'">';var s=this.library["group"+i].split("\n");for(r=0;r<s.length;r++)s[r]&&(s[r]=e.Escape.html(s[r]),n+='<button data-tex="'+s[r]+'" title="'+s[r]+'">$$'+s[r]+"$$</button>");n+="</div>"}n+="</div>",n+="</div>";var o=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",u={sesskey:M.cfg.sesskey,contextid:this.contextids[t],action:"filtertext",text:n};return preview=e.io(o,{sync:!0,data:u,method:"POST"}),preview.status===200&&(n=preview.responseText),n}}},"@VERSION@",{requires:["node","escape","io","event-valuechange","tabview"]});
