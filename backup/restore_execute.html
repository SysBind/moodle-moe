<?PHP //$Id$
    //This page receives the required info and executes the restore
    //with the parameters suplied. Whe finished, delete temporary
    //data from backup_tables and temp directory

    //Get objects from session
    if ($SESSION) {
        $info = $SESSION->info;
        $course_header = $SESSION->course_header;
        $restore = $SESSION->restore;
    }

    //Check login
    require_login();

    //Check admin
    if (!isadmin()) {
        error("You need to be an admin user to use this page.", "$CFG->wwwroot/login/index.php");
    }

    //Check site
    if (!$site = get_site()) {
        error("Site not found!");
    }

    //Start the main table
    echo "<table cellpadding=5>";
    echo "<tr><td>";

    //Start the main ul
    echo "<ul>";

    //Init status
    $status = true;

    //Localtion of the xml file
    $xml_file  = $CFG->dataroot."/temp/backup/".$restore->backup_unique_code."/moodle.xml";

    //If we've selected to restore into new course
    //create it (course)
    //Saving conversion id variables into backup_tables
    if ($restore->restoreto ==1) {
        echo "<li>Creating new course";
        $status = restore_create_new_course($restore,&$course_header);
        //Print course fullname and shortname and category
        if ($status) {
            echo "<ul>";
            echo "<li>".$course_header->course_fullname." (".$course_header->course_shortname.")";
            echo "<li>".get_string("category").": ".$course_header->category->name;
            echo "</ul>";
            //Put the destination course_id
            $restore->course_id = $course_header->course_id;
        }
    } else {
        $course = get_record("course","id",$restore->course_id);
        if ($course) {
            echo "<li>Using existing course"; 
            echo "<ul>";
            echo "<li>From: ".$course_header->course_fullname." (".$course_header->course_shortname.")";
            echo "<li>To: ".$course->fullname." (".$course->shortname.")";
            echo "</ul>";
        }
    }

    //Now create the course_sections and their associated course_modules
    if ($status) {
        if ($restore->restoreto == 1) {
            echo "<li>Creating sections";
            $status = restore_create_sections($restore,$xml_file);
        } else if ($restore->restoreto == 0) {
            echo "<li>Checking sections";
            $status = restore_create_sections($restore,$xml_file);
        } else {
            $status = false;
        }
    }


    //Now create users as needed 
    if ($status and ($restore->users == 0 or $restore->users == 1)) {
        echo "<li>Creating users";
        $status = restore_create_users($restore,$xml_file);
        //Now print info about the work done
        if ($status) {
            $recs = get_records_sql("select old_id, info from {$CFG->prefix}backup_ids
                                     where backup_code = '$restore->backup_unique_code' and
                                     table_name = 'user'");
            //We've records
            if ($recs) {
                $new_count = 0;
                $exists_count = 0;
                $student_count = 0;
                $teacher_count = 0;
                $coursecreator_count = 0;
                $admin_count = 0;
                $other_count = 0;
                //Iterate, filling counters
                foreach ($recs as $rec) {
                    if (strpos($rec->info,"new") !== false) {
                        $new_count++;
                    } 
                    if (strpos($rec->info,"exists") !== false) {
                        $exists_count++;
                    }
                    if (strpos($rec->info,"admin")) {
                        $admin_count++;
                    } else if (strpos($rec->info,"coursecreator")) {
                        $coursecreator_count++;
                    } else if (strpos($rec->info,"teacher")) {
                    $teacher_count++;
                    } else if (strpos($rec->info,"student")) {
                        $student_count++;
                    } else if ($rec->info == "new" or $rec->info == "exists") {
                        $other_count++;
                    }
                }
                //Now print information gathered
                echo " (new: ".$new_count.", existing: ".$exists_count.")";
                echo "<ul>";
                echo "<li>Students: ".$student_count;
                echo "<li>Teachers: ".$teacher_count;
                echo "<li>Course Creators: ".$coursecreator_count;
                echo "<li>Admins: ".$admin_count;
                echo "<li>Other: ".$other_count;
                echo "</ul>";
            } else {
                //Something is wrong. There is no users !!
                $status = false;
            }
        }
    }

    //Now create user_files as needed
    if ($status and ($restore->user_files)) {
        echo "<li>Copying User Files";
        $status = restore_user_files($restore);
        //If all is ok (and we have a counter)
        if ($status and ($status !== true)) {
            //Inform about user dirs created from backup
            echo "<ul>";
            echo "<li>User Zones: ".$status;
            echo "</ul>";
        }
    }

    //Now create course files as needed
    if ($status and ($restore->course_files)) {
        echo "<li>Copying Course Files";
        $status = restore_course_files($restore);
        //If all is ok (and we have a counter)
        if ($status and ($status !== true)) {
            //Inform about user dirs created from backup
            echo "<ul>";
            echo "<li>Main Files/Folders: ".$status;
            echo "</ul>";
        }       
    }

    














    //Now create log entries as needed
    if ($status and ($restore->logs)) {
        echo "<li>Creating Log Entries <b>(not implemented)</b>. Execute after everything...";
    }    

    //Now, if all is OK, adjust the instance field in course_modules !!

    //Now if all is OK, update course modinfo field !!

    //End the main ul
    echo "</ul>";


    //End the main table     
    echo "</tr></td>";
    echo "</table>";

    if (!$status) {
        error ("An error has ocurred");
    }

?>
