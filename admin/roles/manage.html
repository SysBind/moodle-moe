<?php  //$Id$

    switch ($action) {
        case 'add': $submitlabel = get_string('addrole', 'role'); break;
        case 'edit':
        default:  $submitlabel = get_string('savechanges');
    }
?>
<form name="rolesform" action="manage.php" method="post">
<input type="hidden" name="roleid" value="<?php p($roleid) ?>" />
<input type="hidden" name="sesskey" value="<?php p(sesskey()) ?>" />
<input type="hidden" name="action" value="<?php p($action) ?>" />
<input type="hidden" name="contextid" value="<?php p($contextid) ?>" />

<br />
<?php print_string('rolename', 'role'); ?>: <input type="text" name="name" value="<?php p($role->name) ?>" />&nbsp;
<?php print_string('roleshortname', 'role'); ?>: <input type="text" name="shortname" value="<?php p($role->shortname) ?>" />
<br />
<?php print_string('roledescription', 'role'); ?>:
<?php print_textarea($usehtmleditor, 10, 50, 50, 10, 'description', $role->description); ?>
<p>            
<table>
<tr>
<td><?php print_string('capability','role') ?></td>
<td><?php print_string('inherit','role') ?></td>
<td><?php print_string('allow','role') ?></td>
<td><?php print_string('prevent','role') ?></td>
<td><?php print_string('prohibit','role') ?></td>
<td><?php print_string('risks','role') ?></td>
</tr>

<?php 

// init these 2
$contextlevel = 0;
$component = '';

foreach ($capabilities as $capability) {
    // prints a breaker if component or name or context level  
    if ($capability->component != $component or $capability->contextlevel != $contextlevel) {
        echo ('<tr><td colspan="4"><strong>'.
               get_component_string($capability->component, $capability->contextlevel).'</strong></td></tr>');  
    }

    // these 2 are used to see to group same mod/core capabilities together
    $contextlevel = $capability->contextlevel;
    $component = $capability->component;

   // check the capability override for this cap, this role in this context
    $sitecontext = get_context_instance(CONTEXT_SYSTEM, SITEID);

    $localoverride = get_local_override($roleid, $sitecontext->id, $capability->name);

    ?>

        <tr>
        <td><span title="<?php echo $capability->name ?>"><?php echo get_capability_string($capability->name); ?></span></td>
        <td><input TYPE="radio" name="<?php echo $capability->name; ?>" value="0" <?php if (!isset($localoverride->permission) || $localoverride->permission==0){ echo 'checked="checked"'; }?> /></td>
        <td><input TYPE="radio" name="<?php echo $capability->name; ?>" value="1" <?php if (isset($localoverride->permission) && $localoverride->permission==1){ echo 'checked="checked"'; }?> /></td>
        <td ><input TYPE="radio" name="<?php echo $capability->name; ?>" value="-1" <?php if (isset($localoverride->permission) && $localoverride->permission==-1){ echo 'checked="checked"'; }?> /></td>
        <td ><input TYPE="radio" name="<?php echo $capability->name; ?>" value="-1000" <?php if (isset($localoverride->permission) && $localoverride->permission==-1000){ echo 'checked="checked"'; }?> /></td>
        <td><?php
            if (RISK_MANAGETRUST & (int)$capability->riskbitmask) {
                echo "T";
            }
            if (RISK_CONFIG & (int)$capability->riskbitmask) {
                echo "C";
            }
            if (RISK_XSS & (int)$capability->riskbitmask) {
                echo "X";
            }
            if (RISK_PERSONAL & (int)$capability->riskbitmask) {
                echo "P";
            }
            if (RISK_SPAM & (int)$capability->riskbitmask) {
                echo "S";
            }
        ?></td>
        </tr>

<?php } ?>    
</table>     
</p>
<br />
<input type="submit" value="<?php p($submitlabel); ?>" />
</form>
